name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions: {}

env:
  CARGO_TERM_COLOR: always
  # renovate: datasource=github-releases depName=cargo-insta lookupName=mitsuhiko/insta versioning=semver
  CARGO_INSTA_VERSION: 1.43.2
  # renovate: datasource=github-releases depName=shssoichiro/oxipng versioning=semver
  OXIPNG_VERSION: 9.1.5
  # renovate: datasource=github-releases depName=typst/typst versioning=semver
  TYPST_VERSION: 0.13.1

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        persist-credentials: false

    - run: rustup component add rustfmt
    - run: rustup component add clippy

    - name: Install cargo-insta
      run: curl -LsSf https://github.com/mitsuhiko/insta/releases/download/${CARGO_INSTA_VERSION}/cargo-insta-installer.sh | sh

    - name: Install Typst
      run: |
        wget -q "https://github.com/typst/typst/releases/download/v${TYPST_VERSION}/typst-x86_64-unknown-linux-musl.tar.xz"
        tar -xf "typst-x86_64-unknown-linux-musl.tar.xz"
        sudo mv "typst-x86_64-unknown-linux-musl/typst" /usr/local/bin/
        rm -rf "typst-x86_64-unknown-linux-musl" "typst-x86_64-unknown-linux-musl.tar.xz"
        typst --version

    - name: Install oxipng
      run: |
        wget -q "https://github.com/shssoichiro/oxipng/releases/download/v${OXIPNG_VERSION}/oxipng-${OXIPNG_VERSION}-x86_64-unknown-linux-musl.tar.gz"
        tar -xf "oxipng-${OXIPNG_VERSION}-x86_64-unknown-linux-musl.tar.gz"
        sudo mv "oxipng-${OXIPNG_VERSION}-x86_64-unknown-linux-musl/oxipng" /usr/local/bin/
        rm -rf "oxipng-${OXIPNG_VERSION}-x86_64-unknown-linux-musl" "oxipng-${OXIPNG_VERSION}-x86_64-unknown-linux-musl.tar.gz"
        oxipng --version

    - name: Setup fonts
      run: |
        mkdir -p .fonts

        # Download Fira Sans font
        wget -q "https://github.com/mozilla/Fira/archive/4.202.zip"
        unzip -q "4.202.zip"
        mv Fira-4.202/otf/*.otf .fonts/

        # Download Noto CJK font
        wget -q "https://github.com/notofonts/noto-cjk/raw/refs/tags/Sans2.004/Sans/OTC/NotoSansCJK-Regular.ttc" -O .fonts/NotoSansCJK-Regular.ttc

    - uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
      with:
        save-if: ${{ github.ref == 'refs/heads/main' }}

    - run: cargo fetch --locked

    - name: Check formatting
      run: cargo fmt -- --check

    - name: Run clippy
      run: cargo clippy -- -D warnings

    - name: Run tests
      run: cargo insta test --require-full-match --unreferenced=reject --workspace
      env:
        # Write new snapshots into `.snap.new` files (for diffing via CI artifacts).
        INSTA_UPDATE: new
        # Set the path to the fonts directory for Typst.
        TYPST_FONT_PATH: ${{ github.workspace }}/.fonts

    - name: Upload snapshot artifacts on test failure
      if: failure()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: test-snapshots
        path: src/snapshots/
        retention-days: 7
